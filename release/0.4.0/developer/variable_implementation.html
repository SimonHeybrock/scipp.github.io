

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Implementation of class Variable &mdash; scipp  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Customizing Scipp" href="customizing.html" />
    <link rel="prev" title="C++ API for constructing variables" href="constructing_variables.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo-large-v4.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/quick-start.html">Quick start</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/data-structures.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/slicing.html">Slicing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/computation.html">Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/masking.html">Masking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/unaligned-data.html">Unaligned and Realigned Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/groupby.html">GroupBy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/how_to.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/tips-tricks-and-anti-patterns.html">Tips, tricks, and anti-patterns</a></li>
</ul>
<p class="caption"><span class="caption-text">Event data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../event-data/overview.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event-data/overview.html#Arithmetic-operations">Arithmetic operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../event-data/filtering.html">Filtering</a></li>
</ul>
<p class="caption"><span class="caption-text">Visualization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../visualization/representations-and-tables.html">Representations and Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/plotting-overview.html">Plotting Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/plotting-1d-data.html">Plotting 1-D data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/plotting-2d-data.html">Plotting 2-D data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/plotting-nd-data.html">Plotting N-D data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/customizing-figures.html">Customizing figures</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/introduction.html">1-D datasets and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/multi-d-datasets.html">Multi-dimensional datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/neutron-diffraction.html">Neutron Powder Diffraction</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/api.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/api.html#free-functions">Free functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/dtype.html">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/units.html">Physical units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/error-propagation.html">Propagation of uncertainties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python-reference/runtime-configuration.html">Runtime Configuration</a></li>
</ul>
<p class="caption"><span class="caption-text">Neutron-scattering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scipp-neutron/overview.html">Overview: scipp.neutron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipp-neutron/groupby.html">GroupBy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipp-neutron/diffraction.html">Diffraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipp-neutron/from-mantid-to-scipp.html">From Mantid to Scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scipp-neutron/instrument-view.html">Instrument view</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tooling.html">Tooling</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding-conventions.html">Coding conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to.html">How To…</a></li>
<li class="toctree-l1"><a class="reference internal" href="transform.html">Transforming data</a></li>
<li class="toctree-l1"><a class="reference internal" href="constructing_variables.html">C++ API for constructing variables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementation of class Variable</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#type-erasure">Type erasure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#views-and-variables">Views and variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variableconstview">VariableConstView</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="customizing.html">Customizing Scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">About scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/contributing.html">Contributing to scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/release-notes.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scipp</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Implementation of class Variable</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developer/variable_implementation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="implementation-of-class-variable">
<h1>Implementation of class Variable<a class="headerlink" href="#implementation-of-class-variable" title="Permalink to this headline">¶</a></h1>
<p>The implementation of <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">Variable</span></code> and its views <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">VariableConstView</span></code> and <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">VariableView</span></code> are based on two interlinked requirements, type erasure and the concept of views supporting slicing.
The following figure gives an overview of the relations of the involved classes, with relevant details discussed below.
This is simplified to only display essential concepts, omitting many methods:</p>
<a class="reference internal image-reference" href="../_images/variable_classes.svg"><img alt="Variable, related views, and type-erasure mechanism" src="../_images/variable_classes.svg" width="640" /></a>
<div class="section" id="type-erasure">
<h2>Type erasure<a class="headerlink" href="#type-erasure" title="Permalink to this headline">¶</a></h2>
<p>Type erasure is implemented using Sean Parent’s <em>concept based polymorphism</em>.
If we only had to deal with <code class="docutils literal notranslate"><span class="pre">Variable</span></code> the pattern would be implemented using classes <code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code>, <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>, and <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>.
For simplicity, let us initially ignore the classes <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;T&gt;</span></code>, imagining that <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code> is a direct child of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code> provides value-semantics for <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>, essentially providing a copy constructor based on <code class="docutils literal notranslate"><span class="pre">VariableConcept::clone()</span></code>.
<code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> is held in a <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code> since it is an abstract class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> is an abstract class responsible for type erasure.
Its interface contains pure-virtual methods providing common functionality such as copying (<code class="docutils literal notranslate"><span class="pre">clone()</span></code>), accessing the element type (<code class="docutils literal notranslate"><span class="pre">dtype()</span></code>), or comparison (<code class="docutils literal notranslate"><span class="pre">operator==</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code> is a templated child class of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>.
It implements the pure-virtual methods declared in <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> and provides additional methods that depend on <code class="docutils literal notranslate"><span class="pre">T</span></code>, i.e., for accessing the held arrays of values and variances.
Note that this is the <em>same</em> template for all element types <code class="docutils literal notranslate"><span class="pre">T</span></code>, i.e., while there are many child classes of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> they are actually all instances of the same class template.</p></li>
</ul>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">Variable</span></code>, which contains an array of values held by <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>, we need to support <em>views</em> such as <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.
This is provided by <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;T&gt;</span></code>, which also implements the interface of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>.
However, to support <em>interoperability</em> between <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code> an additional level of inheritance is added to the original pattern.
Essentially, we require a common interface between <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code> an <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;T&gt;</span></code> such that operations do not need to support all possible permutations of the two but can instead be implemented using the interface.</p>
<ul class="simple">
<li><p>The common interface is provided by <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code> implements some of (but not all of) the interface of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code> additionally extends the interface with the <code class="docutils literal notranslate"><span class="pre">values()</span></code> and <code class="docutils literal notranslate"><span class="pre">variances()</span></code> methods which do depend on <code class="docutils literal notranslate"><span class="pre">T</span></code> and were thus not defined as part of the type-erased interface given by <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>.</p></li>
</ul>
</div>
<div class="section" id="views-and-variables">
<h2>Views and variables<a class="headerlink" href="#views-and-variables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Instances of <code class="docutils literal notranslate"><span class="pre">Variable</span></code> contain arrays of data.
The member <code class="docutils literal notranslate"><span class="pre">Variable::m_data</span></code> of type <code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code> thus holds a <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>.</p></li>
<li><p>Instances of <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableView</span></code> contains views into arrays of data.
The member <code class="docutils literal notranslate"><span class="pre">VariableConstView::m_view</span></code> of type <code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code> thus holds a <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;T&gt;</span></code>.</p></li>
</ul>
<p>Unfortunately, there is an additional complication required for handling/distinguishing <code class="docutils literal notranslate"><span class="pre">const</span></code> and non-<code class="docutils literal notranslate"><span class="pre">const</span></code> access.
The views cannot simply make use of the constness of the instance, much like the iterators in the standard library come in <code class="docutils literal notranslate"><span class="pre">const</span></code> and non-<code class="docutils literal notranslate"><span class="pre">const</span></code>.
Naively this would lead to, e.g., distinguishing <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;double&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;const</span> <span class="pre">double&gt;</span></code>, but this would result in a combinatoric explosion of the number of cases to handle and implement in operations with multiple inputs.</p>
<ul class="simple">
<li><p>We solve this by not handling constness as part of the type of <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code>.</p></li>
<li><p>Instead, <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;double&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">ViewModel&lt;const</span> <span class="pre">double&gt;</span></code> <em>both</em> implement <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;double&gt;</span></code> .</p></li>
<li><p>Attempts to call mutating methods of <code class="docutils literal notranslate"><span class="pre">VariableConceptT&lt;T&gt;</span></code> will then lead to a <em>runtime</em> failure.
Note that in practice this can never happen since this is wrapped in the higher-level view classes.</p></li>
</ul>
</div>
<div class="section" id="variableconstview">
<h2>VariableConstView<a class="headerlink" href="#variableconstview" title="Permalink to this headline">¶</a></h2>
<p>To support operations without requiring an abundance of overloads, read-only arguments are passed as <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.
<code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableView</span></code> then also work with these operations since:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VariableView</span></code> inherits <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Variable</span></code> is implicitly convertible to <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="customizing.html" class="btn btn-neutral float-right" title="Customizing Scipp" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="constructing_variables.html" class="btn btn-neutral float-left" title="C++ API for constructing variables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020 Scipp contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
         .wy-nav-content { max-width: 1100px; }
  </style>



</body>
</html>