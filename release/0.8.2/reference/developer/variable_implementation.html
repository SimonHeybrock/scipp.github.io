<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Implementation of class Variable &mdash; scipp  documentation</title>
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1-D datasets and tables" href="../../tutorials/introduction.html" />
    <link rel="prev" title="Transforming data" href="transform.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo-large-v4.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
    
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/quick-start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/data-structures.html">Data Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/slicing.html">Slicing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/computation.html">Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/masking.html">Masking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/binned-data.html">Binned Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/groupby.html">GroupBy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/coordinate-transformations.html">Coordinate transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/reading-and-writing-files.html">Reading and Writing Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/how_to.html">How to…</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/tips-tricks-and-anti-patterns.html">Tips, tricks, and anti-patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Visualization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/representations-and-tables.html">Representations and Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/plotting-overview.html">Plotting Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/plotting-in-depth.html">Plotting in depth</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../api.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#creation-functions">Creation functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#free-functions">Free functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#modules">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linear-algebra.html">Linear Algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dtype.html">Data types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../units.html">Physical units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../error-propagation.html">Propagation of uncertainties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runtime-configuration.html">Runtime Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../developer-documentation.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture-decision-records.html">Architecture Decision Records</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding-conventions.html">Coding conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="concepts.html">Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="constructing_variables.html">C++ API for constructing variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="customizing.html">Customizing Scipp</a></li>
<li class="toctree-l2"><a class="reference internal" href="dependencies.html">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to.html">How To…</a></li>
<li class="toctree-l2"><a class="reference internal" href="tooling.html">Tooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="transform.html">Transforming data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Implementation of class Variable</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#type-erasure">Type erasure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#views-and-variables">Views and variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variableconstview">VariableConstView</a></li>
<li class="toctree-l3"><a class="reference internal" href="#binned-variables">Binned variables</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/introduction.html">1-D datasets and tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/multi-d-datasets.html">Multi-dimensional datasets</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/about.html">About scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/whats-new.html">What’s new in scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/contributing.html">Contributing to scipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/release-notes.html">Release Notes</a></li>
</ul>

    <div style="height: 32px; position: fixed; bottom: 0; left: 15px;">
      Select version:&nbsp;
      <select onchange="location = this.value;"
              style="height: 30px; color: #27a54b; background-color: #403d3d;
                    border: 0px; box-shadow: none;">
        <option value="" selected>Pick version</option>
        <option value="https://scipp.github.io">latest (unstable)</option>
        <option value="https://scipp.github.io/release/0.8.2">v0.8</option>
        <option value="https://scipp.github.io/release/0.7.1">v0.7</option>
        <option value="https://scipp.github.io/release/0.6.1">v0.6</option>
        <option value="https://scipp.github.io/release/0.5.0">v0.5</option>
        <option value="https://scipp.github.io/release/0.4.0">v0.4</option>
        <option value="https://scipp.github.io/release/0.3.0">v0.3</option>
      </select>
    </div>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">scipp</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../developer-documentation.html">Developer Documentation</a> &raquo;</li>
      <li>Implementation of class Variable</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/reference/developer/variable_implementation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="implementation-of-class-variable">
<h1>Implementation of class Variable<a class="headerlink" href="#implementation-of-class-variable" title="Permalink to this headline">¶</a></h1>
<p>The implementation of <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">Variable</span></code> and its views <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">VariableConstView</span></code> and <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">VariableView</span></code> are based on two interlinked requirements, type erasure and the concept of views supporting slicing.
The following figure gives an overview of the relations of the involved classes, with relevant details discussed below.
This is simplified to only display essential concepts, omitting many methods:</p>
<a class="reference internal image-reference" href="../../_images/variable_classes.svg"><img alt="Variable, related views, and type-erasure mechanism" src="../../_images/variable_classes.svg" width="640" /></a>
<div class="section" id="type-erasure">
<h2>Type erasure<a class="headerlink" href="#type-erasure" title="Permalink to this headline">¶</a></h2>
<p>Type erasure is implemented using Sean Parent’s <em>concept based polymorphism</em>.
The pattern is implemented using classes <code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code>, <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>, and <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code> provides value-semantics for <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>, essentially providing a copy constructor based on <code class="docutils literal notranslate"><span class="pre">VariableConcept::clone()</span></code>.
<code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> is held in a <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code> since it is an abstract class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> is an abstract class responsible for type erasure.
Its interface contains pure-virtual methods providing common functionality such as copying (<code class="docutils literal notranslate"><span class="pre">clone()</span></code>), accessing the element type (<code class="docutils literal notranslate"><span class="pre">dtype()</span></code>), or comparison (<code class="docutils literal notranslate"><span class="pre">equals</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code> is a templated child class of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code>.
It implements the pure-virtual methods declared in <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> and provides additional methods that depend on <code class="docutils literal notranslate"><span class="pre">T</span></code>, i.e., for accessing the held arrays of values and variances.
Note that this is the <em>same</em> template for all element types <code class="docutils literal notranslate"><span class="pre">T</span></code> (with the exception of binned data, see below), i.e., while there are many child classes of <code class="docutils literal notranslate"><span class="pre">VariableConcept</span></code> they are actually all instances of the same class template.</p></li>
</ul>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">Variable</span></code>, which contains an array of values held by <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>, we need to support <em>views</em> such as <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.
The latter holds <code class="docutils literal notranslate"><span class="pre">ElementArrayViewParams</span></code> (or, in practice, members to construct such an instance).
These parameters are passed to <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;::values</span></code> or <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;::variances</span></code> to construct a typed <code class="docutils literal notranslate"><span class="pre">ElementArrayView&lt;&lt;T&gt;</span></code> with the desired spatial slicing applied.
Interoperability between <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code> is based on <code class="docutils literal notranslate"><span class="pre">ElementArrayView&lt;&lt;T&gt;</span></code>.</p>
</div>
<div class="section" id="views-and-variables">
<h2>Views and variables<a class="headerlink" href="#views-and-variables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Instances of <code class="docutils literal notranslate"><span class="pre">Variable</span></code> contain arrays of data.
The member <code class="docutils literal notranslate"><span class="pre">Variable::m_data</span></code> of type <code class="docutils literal notranslate"><span class="pre">VariableConceptHandle</span></code> thus holds a <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>.</p></li>
<li><p>Instances of <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableView</span></code> contains views into arrays of data.</p></li>
</ul>
<p>The views cannot simply make use of the constness of the instance, much like the iterators in the standard library come in <code class="docutils literal notranslate"><span class="pre">const</span></code> and non-<code class="docutils literal notranslate"><span class="pre">const</span></code>.
Therefore both the <code class="docutils literal notranslate"><span class="pre">const</span></code> pointer <code class="docutils literal notranslate"><span class="pre">VariableConstView::m_variable</span></code> and the non-<code class="docutils literal notranslate"><span class="pre">const</span></code> pointer <code class="docutils literal notranslate"><span class="pre">VariableView::m_mutableVariable</span></code> are required, even though <code class="docutils literal notranslate"><span class="pre">VariableView</span></code> inherits <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.
Access to values or variances via a view will use the respective pointer to access the underlying <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code> of the variable.
This is where the <code class="docutils literal notranslate"><span class="pre">const</span></code>-related overload resolution happens.</p>
</div>
<div class="section" id="variableconstview">
<h2>VariableConstView<a class="headerlink" href="#variableconstview" title="Permalink to this headline">¶</a></h2>
<p>To support operations without requiring an abundance of overloads, read-only arguments are passed as <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.
<code class="docutils literal notranslate"><span class="pre">Variable</span></code> and <code class="docutils literal notranslate"><span class="pre">VariableView</span></code> then also work with these operations since:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VariableView</span></code> inherits <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Variable</span></code> is implicitly convertible to <code class="docutils literal notranslate"><span class="pre">VariableConstView</span></code>.</p></li>
</ul>
</div>
<div class="section" id="binned-variables">
<h2>Binned variables<a class="headerlink" href="#binned-variables" title="Permalink to this headline">¶</a></h2>
<p>Binned variables are implemented using a specialization of <code class="docutils literal notranslate"><span class="pre">DataModel&lt;T&gt;</span></code>.
There is an accompanying specialization of <code class="docutils literal notranslate"><span class="pre">ElementArrayView&lt;T&gt;</span></code>.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="transform.html" class="btn btn-neutral float-left" title="Transforming data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../tutorials/introduction.html" class="btn btn-neutral float-right" title="1-D datasets and tables" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 Scipp contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
    <style>
      .wy-nav-content { max-width: 1100px; }
    </style>
  

</body>
</html>